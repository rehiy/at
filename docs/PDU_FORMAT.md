# PDU 格式详解

本文档详细说明 SMS PDU（Protocol Data Unit）格式，帮助理解短信编码和解码的底层原理。

## 目录

- [PDU 概述](#pdu-概述)
- [PDU 结构](#pdu-结构)
- [字段详解](#字段详解)
- [编码方式](#编码方式)
- [长短信处理](#长短信处理)
- [示例分析](#示例分析)

## PDU 概述

PDU（Protocol Data Unit）是 GSM 网络中用于传输短信的数据格式。它是一个十六进制字符串，包含了短信的所有信息：发送方/接收方号码、时间戳、编码方式、消息内容等。

### 为什么使用 PDU？

- **标准化**：3GPP TS 23.040 定义的国际标准
- **完整性**：包含短信的所有元数据
- **兼容性**：所有 GSM 调制解调器都支持
- **灵活性**：支持多种编码和高级功能

## PDU 结构

### SMS-DELIVER（接收的短信）

```
+--------+----------+----------+--------+--------+--------+--------+--------+--------+
| SMSC   | PDU-Type | Address  | PID    | DCS    | SCTS   | UDL    | UD     |
+--------+----------+----------+--------+--------+--------+--------+--------+--------+
```

### SMS-SUBMIT（发送的短信）

```
+--------+----------+--------+----------+--------+--------+--------+--------+--------+--------+
| SMSC   | PDU-Type | MR     | Address  | PID    | DCS    | VP     | UDL    | UD     |
+--------+----------+--------+----------+--------+--------+--------+--------+--------+--------+
```

## 字段详解

### 1. SMSC（Short Message Service Center）

短信中心号码，格式：

```
[Length] [Type] [Number]
```

**示例**：

```
07 91 683108108300F0
```

- `07`：长度（7 字节）
- `91`：类型（国际号码）
- `683108108300F0`：号码（+8613800138000，BCD 编码并交换半字节）

**特殊情况**：

- `00`：表示使用调制解调器默认的 SMSC

### 2. PDU-Type

PDU 类型字段，1 字节，各位含义：

```
Bit 7 6 | 5 | 4 | 3 2 | 1 0
--------+---+---+-----+----
RP UDHI | SRR| VPF | RD | MTI
```

- **MTI (Message Type Indicator)** [Bit 1-0]：
  - `00`：SMS-DELIVER
  - `01`：SMS-SUBMIT
  - `10`：SMS-STATUS-REPORT

- **VPF (Validity Period Format)** [Bit 4-3]：
  - `00`：无有效期
  - `10`：相对格式（1 字节）
  - `01`：增强格式
  - `11`：绝对格式

- **SRR (Status Report Request)** [Bit 5]：
  - `0`：不请求状态报告
  - `1`：请求状态报告

- **UDHI (User Data Header Indicator)** [Bit 6]：
  - `0`：无用户数据头
  - `1`：包含用户数据头（用于长短信）

**常见值**：

- `0x01`：SMS-SUBMIT，无 UDH，无有效期
- `0x11`：SMS-SUBMIT，无 UDH，有有效期
- `0x41`：SMS-SUBMIT，有 UDH（长短信），无有效期
- `0x04`：SMS-DELIVER，无 UDH

### 3. MR (Message Reference)

消息引用号，1 字节，用于跟踪消息状态。

- `0x00`：由调制解调器自动分配
- `0x01-0xFF`：自定义引用号

### 4. Address（电话号码）

格式：

```
[Length] [Type] [Number]
```

**Length**：数字个数（不包括 '+' 和填充 'F'）

**Type**：

- `0x81`：未知类型
- `0x91`：国际号码（+ 开头）
- `0xD0`：字母数字

**Number**：BCD 编码，半字节交换

**示例**：

```
0D 91 683108108300F0
```

- `0D`：13 个数字
- `91`：国际号码
- `683108108300F0`：+8613800138000

**编码规则**：

1. 去除 '+' 和非数字字符
2. 如果长度为奇数，末尾添加 'F'
3. 每两个字符交换位置

```
+8613800138000
→ 8613800138000
→ 8613800138000F (添加 F)
→ 683108108300F0 (交换)
```

### 5. PID (Protocol Identifier)

协议标识符，1 字节。

- `0x00`：普通短信（最常用）
- `0x40`：替换短信
- 其他值用于特殊用途

### 6. DCS (Data Coding Scheme)

数据编码方案，1 字节，定义编码方式和消息类别。

```
Bit 7 6 5 4 | 3 2 | 1 0
------------+-----+----
  Coding    | Class
```

**常见值**：

- `0x00`：GSM 7-bit，无消息类别
- `0x04`：8-bit 数据
- `0x08`：UCS2（Unicode）
- `0x10`：GSM 7-bit，闪信（Flash Message）
- `0x18`：UCS2，闪信

**编码方式** [Bit 3-2]：

- `00`：GSM 7-bit
- `01`：8-bit
- `10`：UCS2

**消息类别** [Bit 1-0]：

- `00`：立即显示
- `01`：ME 特定
- `10`：SIM 特定
- `11`：TE 特定

### 7. VP (Validity Period)

有效期，指定消息在 SMSC 中保留的时间。

**相对格式**（1 字节）：

| 值范围 | 有效期 |
|--------|--------|
| 0-143 | (VP + 1) × 5 分钟 |
| 144-167 | 12 小时 + (VP - 143) × 30 分钟 |
| 168-196 | (VP - 166) × 1 天 |
| 197-255 | (VP - 192) × 1 周 |

**常用值**：

- `0x0B`：1 小时
- `0x47`：6 小时
- `0xA7`：24 小时
- `0xAD`：1 周
- `0xFF`：最大（63 周）

### 8. SCTS (Service Centre Time Stamp)

时间戳，7 字节（14 个十六进制字符），格式：

```
YY MM DD HH MM SS TZ
```

每对数字需要交换半字节。

**示例**：

```
02 80 26 91 73 14 80
```

解码：

1. 交换每对：`20 08 62 19 37 41 08`
2. 解析：2020-08-26 19:37:41 +08:00

### 9. UDL (User Data Length)

用户数据长度。

- **GSM 7-bit**：septets（7-bit 字符）数量
- **8-bit/UCS2**：字节数

### 10. UD (User Data)

用户数据，包含实际的消息内容。

**结构**（如果有 UDH）：

```
[UDHL] [UDH] [Fill Bits] [Message]
```

- **UDHL**：UDH 长度
- **UDH**：用户数据头（长短信信息）
- **Fill Bits**：填充位（仅 7-bit 编码）
- **Message**：消息内容

## 编码方式

### GSM 7-bit 编码

**字符集**：基本拉丁字符 + 扩展字符

**基本字符**：

```
@£$¥èéùìòÇ\nØø\rÅåΔ_ΦΓΛΩΠΨΣΘΞ ÆæßÉ !"#¤%&'()*+,-./
0123456789:;<=>?¡ABCDEFGHIJKLMNOPQRSTUVWXYZÄÖÑÜ§¿
abcdefghijklmnopqrstuvwxyzäöñüà
```

**扩展字符**（需要转义 0x1B）：

```
| ^ € { } [ ] ~ \
```

**打包算法**：

7-bit 字符打包为 8-bit 字节，每 8 个字符占 7 个字节。

```
字符: A    B    C    D    E    F    G    H
7-bit: 41   42   43   44   45   46   47   48
打包:  C1   E0   32   9B   0D   46   97   41
```

### UCS2 编码

UTF-16 Big Endian 编码，每个字符 2 字节。

**示例**：

```
"你好" → 4F60 597D
```

### 8-bit 编码

原始字节数据，不进行转换。

## 长短信处理

### UDH（User Data Header）

长短信使用 UDH 标识各部分。

**8-bit 引用格式**：

```
[IEI] [IEDL] [REF] [TOTAL] [SEQ]
 00    03    XX     XX      XX
```

- **IEI**：信息元素标识符（0x00 = 8-bit 引用）
- **IEDL**：信息元素数据长度（3）
- **REF**：消息引用号（0x00-0xFF）
- **TOTAL**：总部分数
- **SEQ**：当前部分序号（从 1 开始）

**16-bit 引用格式**：

```
[IEI] [IEDL] [REF_H] [REF_L] [TOTAL] [SEQ]
 08    04     XX      XX       XX      XX
```

### 长度限制

| 编码 | 单条短信 | 长短信每部分 |
|------|----------|--------------|
| GSM 7-bit | 160 字符 | 153 字符 |
| UCS2 | 70 字符 | 67 字符 |

**为什么减少？**

UDH 占用空间：

- UDHL: 1 字节
- UDH: 5 字节（8-bit 引用）或 6 字节（16-bit 引用）
- 填充位（7-bit）：最多 6 bits

## 示例分析

### 示例 1：简单短信（GSM 7-bit）

**PDU**：

```
07911326040000F0040B911346610089F60000208062917314080CC8329BFD06
```

**解析**：

1. **SMSC**：`07911326040000F0`
   - 长度：07
   - 类型：91（国际）
   - 号码：+31624000000

2. **PDU-Type**：`04`
   - SMS-DELIVER，无 UDH

3. **发送方地址**：`0B911346610089F6`
   - 长度：0B（11 个数字）
   - 类型：91（国际）
   - 号码：+31641600986

4. **PID**：`00`（普通短信）

5. **DCS**：`00`（GSM 7-bit）

6. **时间戳**：`208062917314080`
   - 2020-08-26 19:37:14 +08:00

7. **UDL**：`0C`（12 个字符）

8. **UD**：`C8329BFD06`
   - 解码：`hellohello`

### 示例 2：中文短信（UCS2）

**PDU**：

```
0011000D91683108108300F00008AA0C4F60597DFF0C4E16754C
```

**解析**：

1. **SMSC**：`00`（使用默认）

2. **PDU-Type**：`11`
   - SMS-SUBMIT，有有效期

3. **MR**：`00`（自动分配）

4. **目标地址**：`0D91683108108300F0`
   - +8613800138000

5. **PID**：`00`

6. **DCS**：`08`（UCS2）

7. **VP**：`AA`（有效期）

8. **UDL**：`0C`（12 字节）

9. **UD**：`4F60597DFF0C4E16754C`
   - 解码：`你好，世界`

### 示例 3：长短信（第 1 部分）

**PDU**：

```
0041000D91683108108300F00000A00500034201020A...
```

**解析**：

1. **PDU-Type**：`41`
   - SMS-SUBMIT，有 UDH

2. **UDL**：`A0`（160）

3. **UD**：
   - **UDHL**：`05`（5 字节）
   - **UDH**：`00 03 42 02 01`
     - IEI：00（8-bit 引用）
     - IEDL：03
     - REF：42（引用号）
     - TOTAL：02（共 2 部分）
     - SEQ：01（第 1 部分）
   - **消息内容**：...

## 参考标准

- **3GPP TS 23.040**：SMS 技术规范
- **3GPP TS 23.038**：字符集和编码
- **3GPP TS 27.005**：AT 命令集

## 工具和调试

### 手动解码 PDU

1. 使用在线工具：
   - <https://www.smartposition.nl/resources/sms_pdu_calculator.html>
   - <https://www.diafaan.com/sms-tutorials/gsm-modem-tutorial/online-sms-pdu-decoder/>

2. 使用本库：

   ```go
   msg, err := pdu.Decode(pduStr)
   ```

### 生成 PDU

```go
msg := &pdu.Message{
    PhoneNumber: "+8613800138000",
    Text:        "Hello",
    SMSC:        "+8613800138000",
}
pdus, _ := pdu.Encode(msg)
fmt.Println(pdus[0].Data)
```

## 常见问题

### Q: 为什么电话号码要交换半字节？

A: 这是 BCD（Binary Coded Decimal）编码的一部分，用于节省空间。每个十进制数字用 4 bits 表示，两个数字组成一个字节。

### Q: 7-bit 编码为什么这么复杂？

A: 为了在 140 字节的限制内传输更多字符。7-bit 编码可以传输 160 个字符，而 8-bit 只能传输 140 个。

### Q: 长短信如何保证顺序？

A: 使用 UDH 中的序号字段。接收方根据引用号和序号重新组装消息。

### Q: 闪信是什么？

A: 闪信（Flash Message）直接显示在屏幕上，不保存到收件箱。通过 DCS 字段的 Class 位设置。

### Q: 如何发送 emoji？

A: 使用 UCS2 编码。Emoji 是 Unicode 字符，需要 UTF-16 编码。

## 总结

PDU 格式虽然复杂，但提供了完整的短信传输能力。理解 PDU 格式有助于：

1. 调试短信发送/接收问题
2. 实现高级功能（长短信、闪信等）
3. 优化短信编码（选择合适的编码方式）
4. 与调制解调器正确通信

本库封装了所有 PDU 处理细节，让您专注于业务逻辑，而不必担心底层格式。
